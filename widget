// ìš°ë¦¬ ê·¼ë¬´í‘œ ìœ„ì ¯
// Scriptable ì•±ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”

const DB_URL = â€œhttps://our-schedule-ee491-default-rtdb.asia-southeast1.firebasedatabase.appâ€;

const SHIFTS = {
day: { label: â€œDâ€, name: â€œë°ì´â€, color: new Color(â€#7EC8E3â€) },
evening: { label: â€œEâ€, name: â€œì´ë¸Œë‹â€, color: new Color(â€#8FD5A6â€) },
night: { label: â€œNâ€, name: â€œë‚˜ì´íŠ¸â€, color: new Color(â€#F5D76Eâ€) },
off: { label: â€œOFFâ€, name: â€œì˜¤í”„â€, color: new Color(â€#D4A0D0â€) },
};

const WEEKDAYS = [â€œì¼â€,â€œì›”â€,â€œí™”â€,â€œìˆ˜â€,â€œëª©â€,â€œê¸ˆâ€,â€œí† â€];

// Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function fetchData() {
try {
const sReq = new Request(DB_URL + â€œ/schedules.jsonâ€);
const nReq = new Request(DB_URL + â€œ/names.jsonâ€);
const [schedules, names] = await Promise.all([sReq.loadJSON(), nReq.loadJSON()]);
return { schedules: schedules || {}, names: names || [â€œì •ìš°â€, â€œì—¬ìì¹œêµ¬â€] };
} catch {
return { schedules: {}, names: [â€œì •ìš°â€, â€œì—¬ìì¹œêµ¬â€] };
}
}

function getShift(schedules, y, m, d, p) {
const key = y + â€œ-â€ + m + â€œ-â€ + d + â€œ-â€ + p;
return schedules[key] || â€œnoneâ€;
}

// ìœ„ì ¯ ë§Œë“¤ê¸°
async function createWidget() {
const { schedules, names } = await fetchData();
const today = new Date();

const w = new ListWidget();
w.backgroundColor = new Color(â€#F7FBFFâ€);
w.setPadding(12, 14, 12, 14);

// í—¤ë”
const header = w.addStack();
header.centerAlignContent();
const title = header.addText(â€œğŸ‘©â€âš•ï¸ğŸ‘¨â€âš•ï¸ ìš°ë¦¬ ê·¼ë¬´í‘œâ€);
title.font = Font.boldSystemFont(13);
title.textColor = new Color(â€#3A3A4Aâ€);
header.addSpacer();
const dateText = header.addText((today.getMonth()+1) + â€œì›” â€œ + today.getDate() + â€œì¼â€);
dateText.font = Font.mediumSystemFont(11);
dateText.textColor = new Color(â€#A0A4B0â€);

w.addSpacer(8);

// 7ì¼ì¹˜ í‘œì‹œ
for (let i = 0; i < 7; i++) {
const d = new Date(today);
d.setDate(d.getDate() + i);
const y = d.getFullYear();
const m = d.getMonth();
const day = d.getDate();
const dow = d.getDay();

```
const s0 = getShift(schedules, y, m, day, 0);
const s1 = getShift(schedules, y, m, day, 1);

const row = w.addStack();
row.centerAlignContent();
row.spacing = 6;

if (i === 0) {
  row.backgroundColor = new Color("#EEEEF3", 0.5);
  row.cornerRadius = 6;
  row.setPadding(3, 6, 3, 6);
} else {
  row.setPadding(2, 6, 2, 6);
}

// ìš”ì¼ + ë‚ ì§œ
const dayLabel = row.addText(WEEKDAYS[dow] + " " + day + "ì¼");
dayLabel.font = i === 0 ? Font.boldSystemFont(11) : Font.systemFont(11);
dayLabel.textColor = dow === 0 ? new Color("#E88B8B") : dow === 6 ? new Color("#7EB3E0") : new Color("#3A3A4A");
dayLabel.lineLimit = 1;

row.addSpacer();

// ì‚¬ëŒ1 ê·¼ë¬´
if (s0 !== "none") {
  const badge0 = row.addStack();
  badge0.backgroundColor = SHIFTS[s0].color;
  badge0.cornerRadius = 4;
  badge0.setPadding(1, 5, 1, 5);
  const t0 = badge0.addText(SHIFTS[s0].label);
  t0.font = Font.boldSystemFont(9);
  t0.textColor = Color.white();
} else {
  const empty0 = row.addText("  â€”  ");
  empty0.font = Font.systemFont(9);
  empty0.textColor = new Color("#CCCCCC");
}

row.addSpacer(2);

// ì‚¬ëŒ2 ê·¼ë¬´
if (s1 !== "none") {
  const badge1 = row.addStack();
  badge1.backgroundColor = SHIFTS[s1].color;
  badge1.cornerRadius = 4;
  badge1.setPadding(1, 5, 1, 5);
  const t1 = badge1.addText(SHIFTS[s1].label);
  t1.font = Font.boldSystemFont(9);
  t1.textColor = Color.white();
} else {
  const empty1 = row.addText("  â€”  ");
  empty1.font = Font.systemFont(9);
  empty1.textColor = new Color("#CCCCCC");
}

// ê°™ì´ ì‰¬ëŠ” ë‚  / ë™ì‹œ ì¶œê·¼
if (s0 === "off" && s1 === "off") {
  const heart = row.addText(" ğŸ’•");
  heart.font = Font.systemFont(9);
} else if (s0 !== "none" && s1 !== "none" && s0 === s1) {
  const hand = row.addText(" ğŸ¤");
  hand.font = Font.systemFont(9);
}

if (i < 6) w.addSpacer(2);
```

}

w.addSpacer(4);

// ë²”ë¡€
const legend = w.addStack();
legend.centerAlignContent();
const leg0 = legend.addText(â€œâ—€ â€œ + names[0]);
leg0.font = Font.mediumSystemFont(9);
leg0.textColor = new Color(â€#5B9BD5â€);
legend.addSpacer();
const leg1 = legend.addText(names[1] + â€œ â–¶â€);
leg1.font = Font.mediumSystemFont(9);
leg1.textColor = new Color(â€#C07ABCâ€);

// ì›¹ì•± ì—´ê¸°
w.url = â€œhttps://skydiiv-droid.github.io/schedule/â€;

return w;
}

const widget = await createWidget();

if (config.runsInWidget) {
Script.setWidget(widget);
} else {
await widget.presentMedium();
}

Script.complete();